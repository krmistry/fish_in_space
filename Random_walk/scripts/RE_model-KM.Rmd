---
title: "Random Effect model"
author: "Kelly Mistry"
date: "9/23/2021"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# library(reshape2)
# library(tidyverse)
library(here)
library(R2admb)
library(PBSmodelling)
library(dplyr)
library(ggplot2)
library(filesstrings)
library(R.utils)
library(abind)
library(RColorBrewer)
library(reshape2)

# source script with custom functions and initial data set up
source(here("scripts/functions.R"))
source(here("scripts/data_setup.R")) # edit here to change stocks & starting years

```


The format for the data imported below includes an estimate for biomass for each year, which is calculated as a sum of the raw survey catch numbers divided by area surveyed, scaled up for the total area. This calculation is done separately for each subregion, with the raw survey data separated by subregion. The columns that are required to be in the imported data are: SPECIES_CODE, 


```{r set up and implement ADMB}

# I may have figured out what the issue was with running these commands for the last few weeks, although it makes zero sense - I have to either source the whole .Rmd file or copy and paste the compile_admb and run_admb lines into the console, rather than using command-enter to run them piecemeal from the script editing window. No idea why it matters, but ggplots sometimes does this too, so I guess it's not unprecedented, just weird

### Compile and run ADMB-RE model ###
for(sub in 1:N_sub) {
  for(stock in 1:N_stock) {
    # Note: can't use results_folders object inside the below functions
    # Creating file path for re.tpl file
    #re_file <- paste0("results/", subregion[sub], "/", stock_folder_names[stock], "/re")
    # Compile re.tpl file
    compile_admb(fn = paste0("results/", subregion[sub], "/", stock_folder_names[stock], "/re"), re = TRUE, verbose=TRUE) 
    # Run model
    run_admb(fn = paste0("results/", subregion[sub], "/", stock_folder_names[stock], "/re"), verbose = FALSE)
   # Several of the results files are going into the project directory rather than the appropriate subregion/species folder, so this moves them into the appropriate directories
    for(file in 1:length(result_files)) {
      file.rename(here(result_files[file]), paste0(results_folders[stock, sub], "/", result_files[file]))
    }
  }
} 


## Trying out alternative ways to do the above, instead of nested for loops:


# All of the above ran successfully except for Eastern Sebastes polyspinis; received error message "Error in matrix inverse -- matrix singular in inv(dmatrix)"


# clean_admb(fn = paste0(subregion[1], "/", stock_folder_names[1], "/re")) # This deletes a number of files in the results folder, presumably that aren't needed - check with Cecilia if this is something that I might want to do




```


```{r ADMB results}

# There's a final variable in the rwout.rep object, called biomsd.sd, with very small numbers, and I'm not sure what this is. Will probably have to look at the re.tpl file to figure it out, and see if its something I need

# Importing results back in 
all_data_results <- list()
for (stock in 1:N_stock) {
    sub_results <- lapply(subregion, function(x) {
      # Import raw rwout.rep file
        rwout_path <- paste0(results_folders[stock, x], "/rwout.rep")
        # Transform it into a dataframe with custom function (see functions.R for details)
        format_RE_output_fun(rwout_path, stock_names[stock])
      })
  names(sub_results) <- subregion
  all_data_results[[stock]] <- sub_results
}
names(all_data_results) <- stock_folder_names



```


```{r RE and survey data comparison plots}
library(viridis)

# Function to plot the RE predicted biomass vs survey data
comparison_plot_fun <- function(RE_data, survey_data, species, subregion) {
  # Set up custom colors
  myColors <- brewer.pal(3, "Dark2")[c(1:2)]
  
  plot <- ggplot() +
    geom_point(data = RE_data, aes(x = yrs, 
                                   y = biomA, 
                                   color = "RW results")) +
    geom_errorbar(data = RE_data, aes(x = yrs, ymin = LCI, ymax = UCI, color = "RW results")) +
    geom_point(data = survey_data, aes(x = YEAR, y = AREA_BIOMASS,
                                       color = "Survey data")) +
    scale_color_manual(name = "", values = myColors, 
                       labels = c('RW results', "Survey data")) +
    labs(title = paste0(species, " - ", subregion), x = "Years",
         y = "Biomass Estimate (mt)") +
    theme_bw() +
    theme(legend.position = "bottom")
    
    # print(plot)
    ggsave(filename = paste0(species, "_", subregion, ".png"), plot = plot, path = here("results/Plots"))
}


comparison_plot_fun(RE_data = all_data_results[[1]][[1]], survey_data = separated_stock_data[[1]][[1]], species = stock_names[1], subregion = subregion[1])

# Plot each species & subregion combination
for(stock in 1:N_stock) {
  for(sub in 1:N_sub) { 
    comparison_plot_fun(RE_data = all_data_results[[stock]][[sub]], 
                        survey_data = separated_stock_data[[stock]][[sub]], 
                        species = stock_names[stock], 
                        subregion = subregion[sub])
  }
}

# Plot with just survey results, for presentation slide
myColors <- brewer.pal(3, "Dark2")[1]
  
plot <- ggplot() +
  geom_point(data = all_data_results[[1]][[1]], 
             aes(x = yrs, 
                 y = biomA, 
                 color = "RW results")) +
  geom_errorbar(data = all_data_results[[1]][[1]], aes(x = yrs, ymin = LCI, ymax = UCI, color = "RW results")) +
  scale_color_manual(name = "", values = myColors, 
                     labels = c('RW results')) +
  labs(title = stock_names[1], x = "Years",
       y = "Biomass Estimate (mt)") +
  theme_bw() +
  theme(legend.position = "bottom")

# print(plot)
ggsave(filename = paste0(stock_folder_names[1], "_", subregion[1], "_re_results_only.png"), plot = plot, path = here("results/Plots"))

```

```{r resampling}

# Creating new folders for the resampled results (only need to do once)
for(stock in 1:N_stock) {
  for (sub in 1:N_sub) {
    for (year in 1:length(survey_years[[stock]][[sub]])) {
      dir.create(paste0(here("results/Resampling_results/"), stock_folder_names[stock], "/", subregion[sub],"/",  survey_years[[stock]][[sub]][year]), recursive = TRUE)
    }
  }
}


resampled_results_folders <- list()
for (stock in 1:N_stock) {
  stock_folders <- list()
  for (sub in 1:N_sub) {
    species_years <- survey_years[[stock]]
      stock_folders[[sub]] <- lapply(species_years[[sub]], function(x) {
        paste0(here("results/Resampling_results/"), stock_folder_names[stock], "/", subregion[sub], "/", x)
      })
      stock_folders[[sub]] <- unlist(stock_folders[[sub]])
  }
  resampled_results_folders[[stock]] <- stock_folders
  names(stock_folders) <- subregion
}
names(resampled_results_folders) <- stock_folder_names 



# Replacing one year's values with NA doesn't work, as I expected, I get the "error in matrix inverse" message (it does compile, interestingly, just doesn't run)
# Instead, I'll try completely leaving a year out and see what that does...
# Completely omitting the year I want to be missing worked - check to see if there is any issues with doing that instead of NA (which didn't work) 
ptm <- proc.time()

# Run jackknife resampling, saving into appropriate folders
for (stock in 1:N_stock) {
  for (sub in 1:N_sub) {
    for (year in 1:length(survey_years[[stock]][sub])) {
      # Exclude one year of data from the dataset
      jackknifed_data <- separated_stock_data[[stock]][[sub]][-year,]
      # Formatting the data into the re.dat required format
      re.dat <- re.dat_inputs_fun(jackknifed_data, unname(start_years[stock]), unname(end_years[stock]))
      # Writing re.dat into the appropraite folder
      write_dat(paste0(resampled_results_folders[[stock]][[sub]][[year]], "/re"),
                L = re.dat)
      # Copy re.tpl file into folder
      file.copy(from = here("re.tpl"),
                to = resampled_results_folders[[stock]][[sub]][[year]],
                overwrite = TRUE)

    }
  }
}



# Run jackknife resampling, saving into appropriate folders
for (stock in 1:N_stock) {
  for (sub in 1:N_sub) {
    for (year in 1:length(survey_years[[stock]][[sub]])) {
      # Creating partial (rather than full) file path, as required by the below ADMB functions
      resample_folder <- sub(paste0(here(), "/"), "", resampled_results_folders[[stock]][[sub]][[year]])
      # Compile ADMB model
      compile_admb(fn = paste0(resample_folder, "/re"), re = TRUE, verbose=TRUE)
      # Run ADMB model
      run_admb(fn = paste0(resample_folder, "/re"), verbose = FALSE)
      # Move output files that end up in the main project folder into appropriate results folder
      for(file in 1:length(result_files)) {
        file.rename(here(result_files[file]), paste0(resampled_results_folders[[stock]][[sub]][[year]], "/", result_files[file]))
      }
    }
  }
}
proc.time() - ptm
# first time run through it took: 
# user  system elapsed 
# 130.588  48.703 192.989 

```


```{r import resample results}

# Import rwout.rep data, the output of the RE model & format into single object
Resampled_results <- list()
for (stock in 1:N_stock) {
  sub_results <- list()
  species_years <- survey_years[[stock]]
  for (sub in 1:N_sub) {
    year_index <- seq(1:length(species_years[[sub]]))
    sub_results[[sub]] <- lapply(year_index, function(x) {
      # Import raw rwout.rep file
        rwout_path <- paste0(resampled_results_folders[[stock]][[sub]][x], "/rwout.rep")
        # Transform it into a dataframe with custom function (see functions.R for details)
        format_RE_output_fun(rwout_path, stock_names[stock])
      })
    names(sub_results[[sub]]) <- paste0("X", species_years[[sub]])
  }
  names(sub_results) <- subregion
  Resampled_results[[stock]] <- sub_results
}
names(Resampled_results) <- stock_folder_names

  
```


```{r plotting results}
# Plotting Sebastes polyspinis in western subregion to see how it looks
# NOTE: issues with SP - eastern resampled results to check out; everything but 2019 was NA, so need to figure that out

for(sub in 1:N_sub) {
  for(stock in 1:N_stock) {
    basic_plot <- basic_plot_fun(all_data_results[[stock]][[sub]],
               Resampled_results[[stock]][[sub]],
               separated_stock_data[[stock]][[sub]],
               survey_years[[stock]][[sub]],
               stock_names[stock], subregion[sub])
    
    ggsave(filename = paste0(stock_folder_names[stock], "_", subregion[sub], ".png"), plot = basic_plot, path = here("results/Resampling_results/Plots"))
  }
}


```

```{r one species}
# Re-running Re-running Sebastes polyspinis Eastern (trying different options for 0 value) with all data

# Note: can't use results_folders object inside the below functions
# Creating file path for re.tpl file
re_folder <- sub(paste0(here(), "/"), "", results_folders[2, 3])
# Compile re.tpl file
compile_admb(fn = paste0(re_folder, "/re"), re = TRUE, verbose=TRUE) 
# Run model
run_admb(fn = paste0(re_folder, "/re"), verbose = FALSE)
# Several of the results files are going into the project directory rather than the appropriate subregion/species folder, so this moves them into the appropriate directories
for(file in 1:length(result_files)) {
  file.rename(here(result_files[file]), paste0(results_folders[2, 3], "/", result_files[file]))
}


# Importing results back in 
all_data_results <- list()
# Import raw rwout.rep file
rwout_path <- paste0(results_folders[2, 3], "/rwout.rep")
# Transform it into a dataframe with custom function (see functions.R for details)
sub_results <- format_RE_output_fun(rwout_path, stock_names[2])
all_data_results[[1]] <- sub_results
names(all_data_results) <- paste0(stock_folder_names[2], "-", subregion[3])

# Re-running Sebastes polyspinis Eastern (trying different options for 0 value) for resampled data
for (year in 1:length(survey_years[[2]][[3]])) {
  # Exclude one year of data from the dataset
  jackknifed_data <- separated_stock_data[[2]][[3]][-year,]
  # Formatting the data into the re.dat required format
  re.dat <- re.dat_inputs_fun(jackknifed_data, unname(start_years[2]), unname(end_years[2]))
  # Writing re.dat into the appropraite folder
  write_dat(paste0(resampled_results_folders[[2]][[3]][[year]], "/re"),
            L = re.dat)
  # Copy re.tpl file into folder
  file.copy(from = here("re.tpl"),
            to = resampled_results_folders[[2]][[3]][[year]],
            overwrite = TRUE)
}


# Run jackknife resampling, saving into appropriate folders
for (year in 1:length(survey_years[[2]][[3]])) {
  # Creating partial (rather than full) file path, as required by the below ADMB functions
  resample_folder <- sub(paste0(here(), "/"), "", resampled_results_folders[[2]][[3]][[year]])
  # Compile ADMB model
  compile_admb(fn = paste0(resample_folder, "/re"), re = TRUE, verbose=TRUE)
  # Run ADMB model
  run_admb(fn = paste0(resample_folder, "/re"), verbose = FALSE)
  # Move output files that end up in the main project folder into appropriate results folder
  for(file in 1:length(result_files)) {
    file.rename(here(result_files[file]), paste0(resampled_results_folders[[2]][[3]][[year]], "/", result_files[file]))
  }
}

# Import results 
year_index <- seq(1:length(species_years[[3]]))
sub_results <- lapply(year_index, function(x) {
  # Import raw rwout.rep file
  rwout_path <- paste0(resampled_results_folders[[2]][[3]][x], "/rwout.rep")
  # Transform it into a dataframe with custom function (see functions.R for details)
  format_RE_output_fun(rwout_path, stock_names[2])
})
names(sub_results) <- paste0("X", species_years[[3]])


basic_plot <- basic_plot_fun(all_data_results[[1]],
                             sub_results,
                             separated_stock_data[[2]][[3]],
                             survey_years[[2]][[3]],
                             stock_names[2], subregion[3])

ggsave(filename = paste0(stock_folder_names[2], "_", subregion[3], ".png"), plot = basic_plot, path = here("results/Resampling_results/Plots"))

```


